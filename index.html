<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f4f9;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
  max-width: 90%;
  width: 100%;
}

h2 {
  text-align: center;
  color: #333;
}

p {
  text-align: center;
  color: #666;
}

select, input[type=text] {
  width: calc(100% - 32px);
  padding: 16px;
  margin: 8px 0;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-sizing: border-box;
  background-color: #f9f9f9;
}

select:focus, input[type=text]:focus {
  outline: 3px solid #ddd;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: calc(100% - 32px);
  overflow: auto;
  border: 1px solid #ddd;
  z-index: 1;
  max-height: 200px;
  overflow-y: auto;
  border-radius: 8px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.dropdown-content button {
  background-color: white;
  color: black;
  padding: 12px 16px;
  border: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
  border-bottom: 1px solid #ddd;
  transition: background-color 0.3s;
}

.dropdown-content button:hover {
  background-color: #f1f1f1;
}

.show {display: block;}

table {
  width: calc(100% - 32px);
  border-collapse: collapse;
  margin-top: 20px;
}

table, th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

th {
  background-color: #04AA6D;
  color: white;
}

tr:nth-child(even) {
  background-color: #f2f2f2;
}
</style>
</head>
<body>

<div class="container">
  <h2>Search/Filter Dropdown</h2>
  <p>Search the stock and derivatives of your choice. Get the security id of it.</p>

  <select id="exchange" onchange="updateInstruments()">
    <option value="NSE">NSE</option>
    <option value="BSE">BSE</option>
    <option value="MCX">MCX</option>
  </select>

  <select id="instrument">
  </select>

  <label for="keyword">Search: 
    <input id="keyword" type="text" onkeyup="getData()" placeholder="Type to search..." onfocus="handleFocus()">
  </label>
  <div id="myDropdown" class="dropdown-content">
  </div>

<br><br>

  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Security ID</th>
        <th>Exchange</th>
        <th>Segment</th>
        <th>Instrument Type</th>
        <th>Description</th>
        <th>Previous Close</th>
        <th>Upper Price</th>
        <th>Lower Price</th>
      </tr>
    </thead>
    <tbody id="resultsBody">
    </tbody>
  </table>
</div>

<script>
const instrumentOptions = {
  "NSE": ["EQUITY", "OPTIDX", "CURRENCY"],
  "BSE": ["EQUITY", "OPTIDX"],
  "MCX": ["COMMODITY"]
};

const urls = {
  "NSE": {
    "EQUITY": "https://public.fyers.in/sym_details/NSE_CM_sym_master.json",
    "OPTIDX": "https://public.fyers.in/sym_details/NSE_FO_sym_master.json",
    "CURRENCY": "https://public.fyers.in/sym_details/NSE_CD_sym_master.json"
  },
  "BSE": {
    "EQUITY": "https://public.fyers.in/sym_details/BSE_CM_sym_master.json",
    "OPTIDX": "https://public.fyers.in/sym_details/BSE_FO_sym_master.json"
  },
  "MCX": {
    "COMMODITY": "https://public.fyers.in/sym_details/MCX_COM_sym_master.json"
  }
};

document.addEventListener("DOMContentLoaded", () => {
  updateInstruments();
});

function updateInstruments() {
  const exchange = document.getElementById("exchange").value;
  const instrumentSelect = document.getElementById("instrument");
  instrumentSelect.innerHTML = '';
  instrumentOptions[exchange].forEach(option => {
    const opt = document.createElement('option');
    opt.value = option;
    opt.textContent = option.charAt(0) + option.slice(1).toLowerCase();
    instrumentSelect.appendChild(opt);
  });
}

function handleFocus() {
  var divelement = document.getElementById("myDropdown");
  if (!divelement.classList.contains('show')) {
      divelement.classList.add("show");
  }
}

function handleBlur() {
  var divelement = document.getElementById("myDropdown");
  if (divelement.classList.contains('show')) {
      divelement.classList.remove("show");
  }
}

function get_put_data(data) {
  handleBlur();
  displayResults([data]);
}

function getData() {
  const exchange = document.getElementById("exchange").value;
  const keyword = document.getElementById("keyword").value;
  const instrument = document.getElementById("instrument").value;

  const url = urls[exchange][instrument];
  if (!url) {
    console.error('Invalid exchange or instrument type');
    return;
  }

  fetch(url)
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok' + response.statusText);
    }
    return response.json();
  })
  .then(data => {
    const filteredData = filterData(data, keyword);
    add_data_options(filteredData);
  })
  .catch(error => {
    console.error('Some issue occurred!!', error);
  });
}

function filterData(data, keyword) {
  const result = [];
  for (const key in data) {
    if (data.hasOwnProperty(key)) {
      const item = data[key];
      const matchesKeyword = keyword === '' || item.symbolDesc.toLowerCase().includes(keyword.toLowerCase());
      if (matchesKeyword) {
        result.push(item);
      }
    }
  }
  return result;
}

function add_data_options(data) {
  const datalist = document.getElementById('myDropdown');
  datalist.innerHTML = '';
  data.forEach(item => {
    const button = document.createElement('button');
    button.textContent = item['symbolDesc'];
    button.onclick = () => {
      get_put_data(item);
      document.getElementById("myDropdown").classList.remove("show"); // Hide the dropdown after selection
    };
    datalist.appendChild(button);
  });
}

function displayResults(data) {
  const resultsBody = document.getElementById('resultsBody');
  resultsBody.innerHTML = '';

  if (data.length === 0) {
    document.getElementById("resultsTable").style.display = 'none';
    return;
  }

  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.symbolDesc}</td>
      <td>${item.exToken}</td>
      <td>${item.exchangeName}</td>
      <td>${item.segment}</td>
      <td>${item.exInstType}</td>
      <td>${item.symbolDesc}</td>
      <td>${item.previousClose}</td>
      <td>${item.upperPrice}</td>
      <td>${item.lowerPrice}</td>
    `;
    resultsBody.appendChild(row);
  });

  document.getElementById("resultsTable").style.display = 'table';
}
</script>

</body>
</html>
